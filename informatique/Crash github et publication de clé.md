Il y a deux semaines, j'ai voulu migrer mon serveur Ubuntu 20.04 vers 22.04. Mon serveur est auto-hébergé, seul mon serveur de mails se trouve chez Online. Malheureusement, j'ai eu un crash. C'est rare, mais ça arrive, et souvent au pire des moments. Bref, le redémarrage s'est avéré impossible. Pas grave, j'ai suivi ma procédure habituelle (toujours écrire ce que l'on va faire avant de le faire et prévoir le pire). J'ai démarré sur un live USB, fait une sauvegarde du disque en milieu de migration et décidé de restituer ma sauvegarde faite juste avant la migration.

Mais voilà, il s'agissait d'une sauvegarde incrémentale qui ne contenait que les données et non pas les logiciels. Pas très grave, me dis-je. J'avais fait la mise à jour du serveur juste avant de migrer le vendredi après midi. Il me suffisait donc de réinstaller le serveur, de le mettre à jour, de télécharger les paquets, de copier les données et voilà. Le serveur est remis en ligne pour le lundi. Sauf que tout cela fonctionne parfaitement pour les paquets de la distribution et mes CMS Plone d'intranets et d'extranets, mais pas pour le GitLab que j'héberge et qui contient de nombreux projets historiques, voire archéologiques, de ma société.

Après une dizaine d'heures à tout tenter, je me rends compte que, comme par hasard, toutes les sauvegardes de GitLab coincent. Je décide donc d'installer une VM et de restituer mon dernier dump des disques, d'adapter le fstab et grub à la VM, puis de cloner les 64 projets historiques de ma boîte.

Utilisant Git pour tous les documents, il est pour moi bien plus rapide de reconstituer un GitLab à partir des clones que de me battre avec GitLab qui a la fâcheuse habitude de ne pas permettre l'importation des anciennes versions et ne laisse pas le choix que d'aller chercher les vieilles versions de gitlab, de les compiler, faire la migration, puis passer à une version plus récente, et ainsi de suite jusqu'à avoir rattrapé la version courante.

Comme ma société a développé 64 projets en 18ans, j'écris un petit [script](https://github.com/michaellaunay/tools/blob/main/src/export_all_gitlab.py) qui utilise l'API de GitLab pour exporter ces projets. Mais il m'a été impossible d'obtenir tous les projets, j'en avais systématiquement que 19. J'ai creusé l'API, mais en vain, j'ai bien pensé à une optimisation par page, mais n'ai pas trouvé où et comment reconfigurer gitlab. Comme les projets ont des ID internes qui sont des entiers et que le projet le plus récent a un ID de 235, je décide de procéder en mode bourrin et d'itérer de 1 à 400. Et j'ai ainsi pu cloner les vieux projets dignes d'un Indiana Codes et le commit perdu.

Bref, cet incident m'aura coûté 35h de travail, en comptant le temps de la documentation et des scripts,  ce type d'incident est très formateur, il faut donc en profiter pour mettre à jour ses connaissances, ses procédures et sa documentation. Et comme pour les reprises sur incident, tant qu'on n'a pas tout réinstallé "from scratch", on ne sait pas si l'on peut reprendre à 100%.

P.S. J'ai l'habitude d'avoir 3 sauvegardes sur des supports différents et de les conserver tant que mes disques ne sont pas pleins. Dans ce dernier cas, je préfère racheter un disque. Il s'avère qu'en clonant les 64 projets, 4 d'entre eux étaient inconsistants depuis 2020, date à laquelle j'ai subi une intrusion et ai dû là aussi me battre avec gitlab pour restituer mes projets, comme quoi il y des choses qui n'évolue pas. Heureusement, j'ai des archives qui datent d'avant cet incident et j'emploierai la même méthode pour les récupérer.

P.P.S. Mon script est basé sur l'API V4 de GitLab. Pour mes tests sur GitLab.com, j'ai créé un token temporaire que j'ai publié avec mon code source sur mon GitHub (oui, j'utilise les deux plateformes). Il n'a fallu que 30 secondes pour que je reçoive un courrier électronique m'offrant un rapport complet : [https://dashboard.gitguardian.com/core-alerting/incident-resolution/42eb90ae-fcb9-4836-8f19-9ab8759c9220/](https://dashboard.gitguardian.com/core-alerting/incident-resolution/42eb90ae-fcb9-4836-8f19-9ab8759c9220/). J'ai d'ailleurs pu constater que l'API V4 de gitlab n'était pas disponible dans l'offre communautaire. Je n'ai pas creusé davantage, mais il faudra mettre à jour le script.